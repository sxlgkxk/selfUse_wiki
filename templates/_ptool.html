{% extends "layout.html" %}{% block body %}<h1><a href='/c/wiki/tech/linux技术/shell'>wiki/tech/linux技术/shell </a> ptool </h1><hr/><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>
<pre><code>#!/usr/bin/python3

import os
import json
import sys
import shutil
import subprocess as sp

path_exist=os.path.exists
path_join=os.path.join

DEFAULT_CONFIG=path_join(os.environ[&#39;HOME&#39;],&#39;.ptool_config.json&#39;)

app_templates=list()

if not path_exist(DEFAULT_CONFIG):
    res=input(&#39;{} not exist, create it now?(Y/n)&#39;.format(DEFAULT_CONFIG))
    if res in [&#39;&#39;,&#39;Y&#39;,&#39;y&#39;]:
        ip = input(&#39;your site would be serve at: (default:127.0.0.1)&#39;)
        site_path = input(&#39;your site would be save in: (default:{})&#39;.format(os.path.abspath(&#39;.&#39;)))
        if not site_path:
            site_path=os.path.abspath(&#39;.&#39;)
        with open(&#39;{}&#39;.format(DEFAULT_CONFIG),&#39;w&#39;) as f:
            f.write(json.dumps({&quot;ip&quot;:ip,&quot;site_path&quot;:site_path}))
    else:
        print(&#39;you should create config file first\nOR you may change \&#39;DEFAULT_CONFIG\&#39; at line 6 in ptool to save your config in another place&#39;)
        sys.exit()

if len(sys.argv)&lt;2:
    print(&#39;not enough args&#39;)
    print(&#39;use command \&#39;new, status, start/stop\&#39;&#39;)
    sys.exit()

with open(DEFAULT_CONFIG,&#39;r&#39;) as f:
    config=json.loads(f.read())
    ip,site_path=config[&#39;ip&#39;],config[&#39;site_path&#39;]

apptools=dict()
for r,d,f in os.walk(site_path):
    if &#39;apptool&#39; in os.listdir(r):
        if os.path.basename(os.path.dirname(r))==&#39;templates&#39;:
            app_templates.append(os.path.basename(r))
        apptools.update({r[r.rindex(&#39;/&#39;)+1:]:path_join(r,&#39;apptool&#39;)})

def output_new():
    app_template=input(&#39;use app template in {} (default:\&#39;app\&#39;)&#39;.format(app_templates))
    if app_template==&#39;&#39;:
        app_template=&#39;app&#39;
    if len(sys.argv)&gt;=3:
        names=sys.argv[2:]
    else:
        names=[&#39;newapp&#39;]
    for name in names:
        if path_exist(path_join(site_path,name)):
            print(&#39;{} exist, failed to create it&#39;.format(path_join(site_path,name)))
        else:
            shutil.copytree(path_join(site_path,&#39;static/templates&#39;,app_template),path_join(site_path,name))
            print(&#39;{} created successfully&#39;.format(path_join(site_path,name)))

def output_config():
    print(&#39;{} config:\n{}&#39;.format(&#39;DEFAULT_CONFIG&#39;,DEFAULT_CONFIG))
    if len(sys.argv)&gt;=3:
        names=sys.argv[2:]
    else:
        names=list(apptools.keys())
    for name in names:
        p=apptools[name]
        os.chdir(p[:p.rindex(&#39;/&#39;)])
        output=sp.getoutput(&#39;{} {}&#39;.format(p,sys.argv[1]))
        print(output)

def output_exec():
    output=sp.getoutput(&#39;pm2 jlist&#39;)
    process_started=[x[&#39;name&#39;] for x in json.loads(output)]

    if len(sys.argv)&gt;=3:
        names=sys.argv[2:]
    else:
        names=list(apptools.keys())
    for name in names:
        p=apptools[name]
        os.chdir(p[:p.rindex(&#39;/&#39;)])
        action=sys.argv[1]
        if action==&#39;start&#39; and name in process_started:
            action=&#39;restart&#39;
        output=sp.getoutput(&#39;{} {}&#39;.format(p,action))
    output_status()

def output_status():
    output=sp.getoutput(&#39;pm2 jlist&#39;)
    _statuses=json.loads(output)
    names=list(apptools.keys())
    statuses=dict()
    for name in names:
        statuses.update({name:&#39;stopped&#39;})
    for _status in _statuses:
        if _status[&#39;name&#39;] in names:
            statuses.update({_status[&#39;name&#39;]:_status[&#39;pm2_env&#39;][&#39;status&#39;]})
    for name in names:
        print(&#39;{:&lt;10} {:&lt;10}&#39;.format(name,statuses[name]))

if sys.argv[1]==&#39;status&#39;:
    output_status()
elif sys.argv[1] in [&#39;start&#39;,&#39;stop&#39;]:
    output_exec()
elif sys.argv[1]==&#39;new&#39;:
    output_new()
elif sys.argv[1]==&#39;config&#39;:
    output_config()</code></pre>
</body>
</html>{% endblock %}